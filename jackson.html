import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js';
import { getDatabase, ref, onChildAdded, remove } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-database.js';
import { getMessaging, onMessage } from 'https://www.gstatic.com/firebasejs/9.6.10/firebase-messaging.js';

const auth = getAuth();
const database = getDatabase();
const messaging = getMessaging();

const loginForm = document.getElementById('loginForm');
const logoutButton = document.getElementById('logoutButton');
const deleteAllButton = document.getElementById('deleteAllButton');
const authDiv = document.getElementById('auth');
const messagesSection = document.getElementById('messagesSection');
const messagesDiv = document.getElementById('messages');
const notificationSound = document.getElementById('notificationSound');

const motoboy = 'jackson';

if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('/firebase-messaging-sw.js')
        .then(registration => {
            console.log('Service Worker registrado com sucesso:', registration);
        })
        .catch(error => {
            console.log('Falha ao registrar o Service Worker:', error);
        });
}

onAuthStateChanged(auth, (user) => {
    if (user) {
        authDiv.style.display = 'none';
        messagesSection.style.display = 'block';
        loadMessages();
    } else {
        authDiv.style.display = 'block';
        messagesSection.style.display = 'none';
    }
});

deleteAllButton.addEventListener('click', () => {
    if (confirm('Tem certeza que deseja apagar todas as mensagens?')) {
        const messagesRef = ref(database, `messages/${motoboy}`);
        remove(messagesRef).then(() => {
            messagesDiv.innerHTML = '';
        }).catch((error) => {
            alert('Erro ao apagar mensagens: ' + error.message);
        });
    }
});

logoutButton.addEventListener('click', () => {
    signOut(auth).then(() => {
        console.log('Logout realizado com sucesso.');
    }).catch((error) => {
        alert('Erro ao sair: ' + error.message);
    });
});

function loadMessages() {
    const messagesRef = ref(database, `messages/${motoboy}`);
    messagesDiv.innerHTML = '';
    onChildAdded(messagesRef, (data) => {
        const message = data.val().text;
        const messageElement = document.createElement('div');
        messageElement.textContent = message;

        const deleteButton = document.createElement('button');
        deleteButton.textContent = 'X';
        deleteButton.addEventListener('click', () => {
            remove(ref(database, `messages/${motoboy}/${data.key}`));
        });

        messageElement.appendChild(deleteButton);
        messagesDiv.appendChild(messageElement);

        playNotificationSound();
    });
}

function playNotificationSound() {
    notificationSound.currentTime = 0;
    const playPromise = notificationSound.play();
    if (playPromise !== undefined) {
        playPromise.catch(error => {
            console.error('Erro ao reproduzir o som de notificação:', error);
        });
    }
}

window.addEventListener('load', () => {
    notificationSound.play().catch(error => {
        console.log('Erro ao preparar o som de notificação:', error);
    });
});

onMessage(messaging, (payload) => {
    console.log('Mensagem recebida:', payload);
    const { title, body } = payload.notification;
    const options = {
        body,
        icon: 'https://i.ibb.co/jZ6rbSp/logo-cabana.png'
    };

    if (Notification.permission === 'granted') {
        new Notification(title, options);
        playNotificationSound();
    }
});
